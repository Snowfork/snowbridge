# Ethereum Contracts

This directory contains smart contracts utilized by the Polkadot-Ethereum Bridge.

## Development

Requirements:
* Node 14 LTS. See installation [instructions](https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-ubuntu-20-04#option-3-%E2%80%94-installing-node-using-the-node-version-manager).
* Yarn
* direnv: https://direnv.net/docs/installation.html

Install dependencies with yarn:

```bash
yarn install
```

Create an `.envrc` file using [.envrc.template](.envrc.template) as a template. Note that deploying to ropsten network requires setting the INFURA_PROJECT_ID and ROPSTEN_PRIVATE_KEY environment variables.

Example:

```bash
cp .envrc-example .envrc
direnv allow
```

## Testing

Run tests:

```bash
npx hardhat test
```

### Updating fixture data for unit tests

We use logging artifacts from the relayer in E2E stack as a source of compliant fixture data.

BEEFY commitment & proofs extracted from `../test/beefy-relay.log`.
* test/fixtures/beefy-relay-basic.json
* test/fixtures/beefy-relay-incentivized.json

Message bundles & proofs extracted from `../test/parachain-relay.log`.
* test/fixtures/parachain-relay-basic.json
* test/fixtures/parachain-relay-incentivized.json

First, change to the E2E test directory at `../test`.

1. Run the following tests to initiate bridge activity and produce logging data
```bash
yarn test --grep 'should transfer DOT from Substrate to Ethereum \(basic channel\)'
yarn test --grep 'should transfer ETH from Ethereum to Substrate \(incentivized channel\)'
yarn test --grep 'should transfer DOT from Substrate to Ethereum \(incentivized channel\)'
```

Steps for updating the fixture data for the basic channel:
1. Grep for `Sent transaction BasicInboundChannel.submit` in `parachain-relay.json`
2. Copy that log line into `./test/fixtures/parachain-relay-basic.json`
3. In that file, take the `beefyBlock` field (a block hash) and use polkadot.js explorer to find the corresponding block number.
4. Run the following (substituting `$BLOCKNUMBER`) and paste the output into `./test/fixtures/beefy-relay-basic.json`:
```bash
jq -s --argjson blocknumber $BLOCKNUMBER '.[] | select( .message | contains("Sent SubmitFinal transaction")) | select( .params.commitment.blockNumber | contains($blocknumber))' beefy-relay.log
```
5: NOTE: if the produced `./test/fixtures/beefy-relay-basic.json` doesn't contain a `params.leaf` field, repeat all the steps again.

Steps for updating the fixture data for the basic channel:
1. Grep for `Sent transaction IncentivizedInboundChannel.submit` in `parachain-relay.json`
2. Copy that log line into `./test/fixtures/parachain-relay-incentivized.json`
3. In that file, take the `beefyBlock` field (a hash) and use polkadot.js explorer to find the corresponding block number.
4. Run the following (substituting `$BLOCKNUMBER`) and paste the output into `./test/fixtures/beefy-relay-incentivized.json`:
```bash
jq -s --argjson blocknumber $BLOCKNUMBER '.[] | select( .message | contains("Sent SubmitFinal transaction")) | select( .params.commitment.blockNumber | contains($blocknumber))' beefy-relay.log
```

## Deployment

### Local

Example: Run a local hardhat instance with deployments

```
yarn hardhat node
```

### Ropsten, Mainnet

```
yarn hardhat deploy --network ropsten
```

## Tasks

### Upgrade an app

Example: upgrade an app to use a different set of channels

```sh
# Do something first to deploy new channels, then provide addresses below
yarn hardhat upgrade \
  --appaddr       0x3f0839385DB9cBEa8E73AdA6fa0CFe07E321F61d \
  --basicinbound  0x0000000000000000000000000000000000000001 \
  --basicoutbound 0x0000000000000000000000000000000000000002 \
  --incinbound    0x0000000000000000000000000000000000000003 \
  --incoutbound   0x0000000000000000000000000000000000000004 \
  --network       localhost # change to ropsten or mainnet accordingly
```

### Renounce ownership of the CHANNEL_UPGRADE_ROLE

```sh
yarn hardhat renounce \
  --appaddr 0x3f0839385DB9cBEa8E73AdA6fa0CFe07E321F61d \
  --network localhost
```

### View the address of deployed contract's

```sh
yarn hardhat  contractAddressList \
  --network localhost # change to ropsten or mainnet accordingly
```

## Autogenerated Documentation

Solidity documentation can be autogenerated using the [solidity-docgen](https://github.com/OpenZeppelin/solidity-docgen) library. It will generate markdown files from the contracts directory and output them to the docs directory.

```bash
# The library is only compatible with npx
npx solidity-docgen
```
