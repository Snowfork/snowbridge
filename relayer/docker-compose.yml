x-logging: &awslogs
  driver: awslogs
  options:
    awslogs-region: ${AWS_REGION}
    awslogs-group: snowbridge/${ENVIRONMENT:-prod}
    awslogs-create-group: "true"

services:
  beacon-state-service:
    image: ghcr.io/snowfork/snowbridge-relay
    build:
      context: ..
      dockerfile: relayer/Dockerfile
      args:
        - GAS_ESTIMATOR_NETWORK=${GAS_ESTIMATOR_NETWORK:-polkadot}
    platform: linux/amd64
    command: run beacon-state-service --config /config/beacon-state-service.json
    volumes:
      - ./config/docker:/config
      - beacon-state-data:/data
    ports:
      - "8080:8080"
    environment:
      - BEACON_ENDPOINT=${BEACON_ENDPOINT}
      - FORK_DENEB=${FORK_DENEB}
      - FORK_ELECTRA=${FORK_ELECTRA}
      - FORK_FULU=${FORK_FULU}
    restart: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      <<: *awslogs
      options:
        awslogs-region: ${AWS_REGION}
        awslogs-group: snowbridge/${ENVIRONMENT:-prod}
        awslogs-stream: beacon-state-service
        awslogs-create-group: "true"

  beacon:
    image: ghcr.io/snowfork/snowbridge-relay
    platform: linux/amd64
    command: >
      run beacon
      --config /config/beacon.json
      --substrate.private-key-id ${BEACON_RELAY_SUBSTRATE_KEY_ID}
    volumes:
      - ./config/docker:/config
      - beacon-data:/data
    environment:
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - BEACON_ENDPOINT=${BEACON_ENDPOINT}
      - BRIDGEHUB_ENDPOINT=${BRIDGEHUB_ENDPOINT}
      - FORK_DENEB=${FORK_DENEB}
      - FORK_ELECTRA=${FORK_ELECTRA}
      - FORK_FULU=${FORK_FULU}
      - MAX_WATCHED_EXTRINSICS=${MAX_WATCHED_EXTRINSICS:-200}
    restart: on-failure
    depends_on:
      beacon-state-service:
        condition: service_healthy
    logging:
      <<: *awslogs
      options:
        awslogs-region: ${AWS_REGION}
        awslogs-group: snowbridge/${ENVIRONMENT:-prod}
        awslogs-stream: beacon-relay
        awslogs-create-group: "true"

  ethereum-v2:
    image: ghcr.io/snowfork/snowbridge-relay
    platform: linux/amd64
    command: >
      run ethereum-v2
      --config /config/ethereum-v2.json
      --substrate.private-key-id ${EXECUTION_RELAY_SUBSTRATE_KEY_ID}
    volumes:
      - ./config/docker:/config
    environment:
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - BEACON_ENDPOINT=${BEACON_ENDPOINT}
      - ETHEREUM_ENDPOINT=${ETHEREUM_ENDPOINT}
      - BRIDGEHUB_ENDPOINT=${BRIDGEHUB_ENDPOINT}
      - ASSETHUB_ENDPOINT=${ASSETHUB_ENDPOINT}
      - FORK_DENEB=${FORK_DENEB}
      - FORK_ELECTRA=${FORK_ELECTRA}
      - FORK_FULU=${FORK_FULU}
      - GATEWAY_CONTRACT=${GATEWAY_CONTRACT}
      - MAX_WATCHED_EXTRINSICS=${MAX_WATCHED_EXTRINSICS:-200}
      - CHAINALYSIS_API_KEY=${CHAINALYSIS_API_KEY}
      - OFAC_ENABLED=${OFAC_ENABLED:-false}
    restart: on-failure
    depends_on:
      beacon-state-service:
        condition: service_healthy
    logging:
      <<: *awslogs
      options:
        awslogs-region: ${AWS_REGION}
        awslogs-group: snowbridge/${ENVIRONMENT:-prod}
        awslogs-stream: ethereum-v2-relay
        awslogs-create-group: "true"

  ethereum:
    image: ghcr.io/snowfork/snowbridge-relay
    platform: linux/amd64
    command: >
      run ethereum
      --config /config/ethereum.json
      --substrate.private-key-id ${EXECUTION_V1_RELAY_SUBSTRATE_KEY_ID}
    volumes:
      - ./config/docker:/config
    environment:
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - BEACON_ENDPOINT=${BEACON_ENDPOINT}
      - ETHEREUM_ENDPOINT=${ETHEREUM_ENDPOINT}
      - BRIDGEHUB_ENDPOINT=${BRIDGEHUB_ENDPOINT}
      - FORK_DENEB=${FORK_DENEB}
      - FORK_ELECTRA=${FORK_ELECTRA}
      - FORK_FULU=${FORK_FULU}
      - GATEWAY_CONTRACT=${GATEWAY_CONTRACT}
      - CHANNEL_ID=${CHANNEL_ID}
      - SS58_PREFIX=${SS58_PREFIX:-0}
      - MAX_WATCHED_EXTRINSICS=${MAX_WATCHED_EXTRINSICS:-200}
      - CHAINALYSIS_API_KEY=${CHAINALYSIS_API_KEY}
      - OFAC_ENABLED=${OFAC_ENABLED:-false}
    restart: on-failure
    depends_on:
      beacon-state-service:
        condition: service_healthy
    logging:
      <<: *awslogs
      options:
        awslogs-region: ${AWS_REGION}
        awslogs-group: snowbridge/${ENVIRONMENT:-prod}
        awslogs-stream: ethereum-relay
        awslogs-create-group: "true"

  beefy:
    image: ghcr.io/snowfork/snowbridge-relay
    platform: linux/amd64
    profiles:
      - expensive
    command: >
      run beefy
      --config /config/beefy.json
      --ethereum.private-key-id ${BEEFY_RELAY_ETHEREUM_KEY_ID}
    volumes:
      - ./config/docker:/config
    environment:
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - POLKADOT_ENDPOINT=${POLKADOT_ENDPOINT}
      - BRIDGEHUB_ENDPOINT=${BRIDGEHUB_ENDPOINT}
      - ETHEREUM_ENDPOINT=${ETHEREUM_ENDPOINT}
      - GATEWAY_CONTRACT=${GATEWAY_CONTRACT}
      - BEEFY_CLIENT_CONTRACT=${BEEFY_CLIENT_CONTRACT}
    restart: on-failure
    logging:
      <<: *awslogs
      options:
        awslogs-region: ${AWS_REGION}
        awslogs-group: snowbridge/${ENVIRONMENT:-prod}
        awslogs-stream: beefy-relay
        awslogs-create-group: "true"

  parachain-v2:
    image: ghcr.io/snowfork/snowbridge-relay
    platform: linux/amd64
    command: >
      run parachain-v2
      --config /config/parachain-v2.json
      --ethereum.private-key-id ${PARACHAIN_RELAY_ETHEREUM_KEY_ID}
    volumes:
      - ./config/docker:/config
    environment:
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - ETHEREUM_ENDPOINT=${ETHEREUM_ENDPOINT}
      - POLKADOT_ENDPOINT=${POLKADOT_ENDPOINT}
      - BRIDGEHUB_ENDPOINT=${BRIDGEHUB_ENDPOINT}
      - FLASHBOTS_ENDPOINT=${FLASHBOTS_ENDPOINT}
      - GATEWAY_CONTRACT=${GATEWAY_CONTRACT}
      - BEEFY_CLIENT_CONTRACT=${BEEFY_CLIENT_CONTRACT}
      - REWARD_ADDRESS=${REWARD_ADDRESS}
      - CHAINALYSIS_API_KEY=${CHAINALYSIS_API_KEY}
      - OFAC_ENABLED=${OFAC_ENABLED:-false}
    restart: on-failure
    logging:
      <<: *awslogs
      options:
        awslogs-region: ${AWS_REGION}
        awslogs-group: snowbridge/${ENVIRONMENT:-prod}
        awslogs-stream: parachain-v2-relay
        awslogs-create-group: "true"

  reward:
    image: ghcr.io/snowfork/snowbridge-relay
    platform: linux/amd64
    command: >
      run reward
      --config /config/reward.json
      --substrate.private-key-id ${REWARD_RELAY_SUBSTRATE_KEY_ID}
    volumes:
      - ./config/docker:/config
    environment:
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - BEACON_ENDPOINT=${BEACON_ENDPOINT}
      - ETHEREUM_ENDPOINT=${ETHEREUM_ENDPOINT}
      - BRIDGEHUB_ENDPOINT=${BRIDGEHUB_ENDPOINT}
      - FORK_DENEB=${FORK_DENEB}
      - FORK_ELECTRA=${FORK_ELECTRA}
      - FORK_FULU=${FORK_FULU}
      - GATEWAY_CONTRACT=${GATEWAY_CONTRACT}
      - MAX_WATCHED_EXTRINSICS=${MAX_WATCHED_EXTRINSICS:-200}
      - REWARD_ADDRESS=${REWARD_ADDRESS}
    restart: on-failure
    depends_on:
      beacon-state-service:
        condition: service_healthy
    logging:
      <<: *awslogs
      options:
        awslogs-region: ${AWS_REGION}
        awslogs-group: snowbridge/${ENVIRONMENT:-prod}
        awslogs-stream: reward-relay
        awslogs-create-group: "true"

  parachain:
    image: ghcr.io/snowfork/snowbridge-relay
    platform: linux/amd64
    command: >
      run parachain
      --config /config/parachain.json
      --ethereum.private-key-id ${PARACHAIN_V1_RELAY_ETHEREUM_KEY_ID}
    volumes:
      - ./config/docker:/config
    environment:
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - ETHEREUM_ENDPOINT=${ETHEREUM_ENDPOINT}
      - POLKADOT_ENDPOINT=${POLKADOT_ENDPOINT}
      - BRIDGEHUB_ENDPOINT=${BRIDGEHUB_ENDPOINT}
      - FLASHBOTS_ENDPOINT=${FLASHBOTS_ENDPOINT}
      - GATEWAY_CONTRACT=${GATEWAY_CONTRACT}
      - BEEFY_CLIENT_CONTRACT=${BEEFY_CLIENT_CONTRACT}
      - CHANNEL_ID=${CHANNEL_ID}
      - CHAINALYSIS_API_KEY=${CHAINALYSIS_API_KEY}
      - OFAC_ENABLED=${OFAC_ENABLED:-false}
    restart: on-failure
    logging:
      <<: *awslogs
      options:
        awslogs-region: ${AWS_REGION}
        awslogs-group: snowbridge/${ENVIRONMENT:-prod}
        awslogs-stream: parachain-relay
        awslogs-create-group: "true"

  beefy-on-demand:
    image: ghcr.io/snowfork/snowbridge-relay
    platform: linux/amd64
    profiles:
      - expensive
    command: >
      run beefy
      --config /config/beefy.json
      --ethereum.private-key-id ${BEEFY_ON_DEMAND_RELAY_ETHEREUM_KEY_ID}
      --on-demand
    volumes:
      - ./config/docker:/config
    environment:
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - POLKADOT_ENDPOINT=${POLKADOT_ENDPOINT}
      - BRIDGEHUB_ENDPOINT=${BRIDGEHUB_ENDPOINT}
      - ETHEREUM_ENDPOINT=${ETHEREUM_ENDPOINT}
      - GATEWAY_CONTRACT=${GATEWAY_CONTRACT}
      - BEEFY_CLIENT_CONTRACT=${BEEFY_CLIENT_CONTRACT}
    restart: on-failure
    logging:
      <<: *awslogs
      options:
        awslogs-region: ${AWS_REGION}
        awslogs-group: snowbridge/${ENVIRONMENT:-prod}
        awslogs-stream: beefy-on-demand-relay
        awslogs-create-group: "true"

volumes:
  beacon-state-data:
  beacon-data:
